<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intro to Javascript</title>
    <style>
        
    </style>
</head>
<body>
    <form action="" method="get">
        <label for="country">Country</label>
        <select name="country" id="country">
            <option value="">Select...</option>
            <option value="test">test</option>
        </select>
        <br>
        <label for="state">State</label>
        <select name="state" id="state">
            <option value="">Select...</option>
        </select>
    </form>
    <script>
        const apiToken = '2n-__D3JK1ykprTvekJ5QWq3KIuTnnWyMISwqvAPx5z3E4FtzBfFUFlTDUpJTtQ4vzk';
        const userEmail = 'hgjoka16@gmail.com';

        const countriSelectInput = document.getElementById('country');
        const stateSelectInput = document.getElementById('state');

        function getCountries(token) {
            fetch('https://www.universal-tutorial.com/api/countries', {
                headers: {
                    Accept: 'application/json',
                    Authorization: 'Bearer ' + token
                }
            })
            .then((response) => {
                return response.json();
            })
            .then((countries) => {
                for (const country of countries) {
                        const countryOption = document.createElement('option');
                        countryOption.value = country.country_name;
                        countryOption.innerText = country.country_name;

                        countriSelectInput.appendChild(countryOption);
                    }
            });
        }

        async function getAccessToken() {
            const response = await fetch(
                'https://www.universal-tutorial.com/api/getaccesstoken',
                {
                   method: 'GET',
                   headers: {
                        Accept: 'application/json',
                        'api-token': apiToken,
                        'user-email': userEmail
                   }
                }
            );

            const accessToken = await response.json();

            if ('auth_token' in accessToken) {
                return accessToken.auth_token;
            }

            throw new Error(accessToken.error);
        }

        // getAccessToken().then(getCountries);
        getAccessToken()
        .then((auth_token) => {
            getCountries(auth_token);
        })
        .catch(console.log);

        async function getStates(country, token) {
            const response = await fetch('https://www.universal-tutorial.com/api/states/' + country, {
                headers: {
                    Accept: 'application/json',
                    Authorization: 'Bearer ' + token
                }
            });

            const states = await response.json();

            for (const state of states) {
                const stateOption = document.createElement('option');
                stateOption.value = state.state_name;
                stateOption.innerText = state.state_name;

                stateSelectInput.appendChild(stateOption);
            }
        }

        countriSelectInput.addEventListener('change', async (event) => {
            const country = event.target.value;

            let token;

            try {
                token = await getAccessToken();
            } catch (error) {
                alert(error);
            } finally {
                if (token) getStates(country, token);
            }
        });

        // Beni te njejten gje per cities
    </script>
</body>
</html>