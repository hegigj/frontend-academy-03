<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intro to Javascript</title>
    <style>
        
    </style>
    <script>
        function httpRequest(method, url, headerMap, responseHandler) {
            const http = new XMLHttpRequest();

            http.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    const response = JSON.parse(this.response);

                    responseHandler(response);
                }
            };

            http.open(method, url);

            http.setRequestHeader('Accept', 'application/json');
            for (const headerName of headerMap.keys()) {
                http.setRequestHeader(headerName, headerMap.get(headerName));
            }

            http.send();
        }
    </script>
</head>
<body>
    <form action="" method="get">
        <label for="country">Country</label>
        <select name="country" id="country">
            <option value="">Select...</option>
        </select>
        <br>
        <label for="state">State</label>
        <select name="state" id="state">
            <option value="">Select...</option>
        </select>
    </form>
    <script>
        const apiToken = '2n-__D3JK1ykprTvekJ5QWq3KIuTnnWyMISwqvAPx5z3E4FtzBfFUFlTDUpJTtQ4vzk';
        const userEmail = 'hgjoka16@gmail.com';

        const countriSelectInput = document.getElementById('country');
        const stateSelectInput = document.getElementById('state');

        function getCountries(token) {
            fetch('https://www.universal-tutorial.com/api/countries', {
                headers: {
                    Accept: 'application/json',
                    Authorization: 'Bearer ' + token
                }
            })
            .then((response) => {
                return response.json();
            })
            .then((countries) => {
                for (const country of countries) {
                        const countryOption = document.createElement('option');
                        countryOption.value = country.country_name;
                        countryOption.innerText = country.country_name;

                        countriSelectInput.appendChild(countryOption);
                    }
            });
        }

        function getAccessToken(authutorizedRequest) {
            fetch(
                'https://www.universal-tutorial.com/api/getaccesstoken',
                {
                   method: 'GET',
                   headers: {
                        Accept: 'application/json',
                        'api-token': apiToken,
                        'user-email': userEmail
                   }
                }
            )
            .then((response) => {
                return response.json();
            })
            .then((text) => {
                authutorizedRequest(text.auth_token);
            });
            // .catch(console.error);

            // return new Promise((resolve, reject) => {
            //     const http = new XMLHttpRequest();

            //     http.onreadystatechange = function () {
            //         if (this.readyState === 4 && this.status === 200) {
            //             const response = JSON.parse(this.response);
            //             reject(response);
            //         }
            //     };

            //     http.open('GET', 'https://www.universal-tutorial.com/api/getaccesstoken');
            //     http.setRequestHeader('Accept', 'application/json');
            //     http.setRequestHeader('api-token', apiToken);
            //     http.setRequestHeader('user-email', userEmail);

            //     http.send();
            // });
        }

        // getAccessToken(getCountries).catch(response => {
        //     getCountries(response.auth_token);
        // });
        getAccessToken(getCountries);

        function getStates(country) {
            return (token) => {
                fetch('https://www.universal-tutorial.com/api/states/' + country, {
                    headers: {
                        Accept: 'application/json',
                        Authorization: 'Bearer ' + token
                    }
                })
                .then((response) => {
                    return response.json();
                })
                .then((states) => {
                    for (const state of states) {
                        const stateOption = document.createElement('option');
                        stateOption.value = state.state_name;
                        stateOption.innerText = state.state_name;

                        stateSelectInput.appendChild(stateOption);
                    }
                });
            };
        }

        countriSelectInput.addEventListener('change', event => {
            const country = event.target.value;

            getAccessToken(getStates(country));
        });

        // Beni te njejten gje per cities
    </script>
</body>
</html>